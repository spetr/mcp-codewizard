name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to build (e.g., v0.1.0)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build:
    name: Build ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux AMD64
          - os: linux
            arch: amd64
            runner: ubuntu-latest
            ext: ''
            cc: clang
          # Linux ARM64
          - os: linux
            arch: arm64
            runner: ubuntu-24.04-arm
            ext: ''
            cc: clang
          # macOS AMD64 (cross-compile from ARM64)
          - os: darwin
            arch: amd64
            runner: macos-14
            ext: ''
            cc: clang
          # macOS ARM64
          - os: darwin
            arch: arm64
            runner: macos-14
            ext: ''
            cc: clang
          # Windows AMD64
          - os: windows
            arch: amd64
            runner: windows-latest
            ext: '.exe'
            cc: clang
          # Windows ARM64 (cross-compile from AMD64)
          - os: windows
            arch: arm64
            runner: windows-latest
            ext: '.exe'
            cc: clang

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Install dependencies (Linux)
        if: matrix.os == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang

      - name: Install dependencies (Windows AMD64)
        if: matrix.os == 'windows' && matrix.arch == 'amd64'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          install: mingw-w64-x86_64-clang mingw-w64-x86_64-make mingw-w64-x86_64-sqlite3
          path-type: inherit

      - name: Install dependencies (Windows ARM64)
        if: matrix.os == 'windows' && matrix.arch == 'arm64'
        shell: pwsh
        run: |
          # Download llvm-mingw for ARM64 cross-compilation
          $llvmVersion = "20231128"
          $url = "https://github.com/mstorsjo/llvm-mingw/releases/download/$llvmVersion/llvm-mingw-$llvmVersion-ucrt-x86_64.zip"
          Invoke-WebRequest -Uri $url -OutFile llvm-mingw.zip
          Expand-Archive llvm-mingw.zip -DestinationPath C:\
          $llvmPath = (Get-ChildItem C:\llvm-mingw-*).FullName
          echo "$llvmPath\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            VERSION="${{ github.event.inputs.tag }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build binary (Unix)
        if: matrix.os != 'windows'
        env:
          CGO_ENABLED: '1'
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CC: ${{ matrix.cc }}
        run: |
          go build -ldflags "-s -w -X main.version=${{ steps.version.outputs.version }}" \
            -o mcp-codewizard${{ matrix.ext }} \
            ./cmd/mcp-codewizard

      - name: Build binary (Windows AMD64)
        if: matrix.os == 'windows' && matrix.arch == 'amd64'
        shell: msys2 {0}
        timeout-minutes: 15
        run: |
          export CGO_ENABLED=1
          export PATH="/mingw64/bin:$PATH"
          go build -ldflags "-s -w -X main.version=${{ steps.version.outputs.version }}" \
            -o mcp-codewizard.exe \
            ./cmd/mcp-codewizard

      - name: Build binary (Windows ARM64)
        if: matrix.os == 'windows' && matrix.arch == 'arm64'
        shell: pwsh
        timeout-minutes: 15
        env:
          CGO_ENABLED: '1'
          GOOS: windows
          GOARCH: arm64
          CC: aarch64-w64-mingw32-clang
        run: |
          go build -ldflags "-s -w -X main.version=${{ steps.version.outputs.version }}" `
            -o mcp-codewizard.exe `
            ./cmd/mcp-codewizard

      - name: Create archive (Unix)
        if: matrix.os != 'windows'
        run: |
          mkdir -p dist
          tar -czvf dist/mcp-codewizard-${{ steps.version.outputs.version }}-${{ matrix.os }}-${{ matrix.arch }}.tar.gz \
            mcp-codewizard${{ matrix.ext }} \
            README.md \
            CLAUDE.md

      - name: Create archive (Windows)
        if: matrix.os == 'windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Compress-Archive -Path mcp-codewizard.exe, README.md, CLAUDE.md `
            -DestinationPath dist/mcp-codewizard-${{ steps.version.outputs.version }}-${{ matrix.os }}-${{ matrix.arch }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: mcp-codewizard-${{ matrix.os }}-${{ matrix.arch }}
          path: dist/*
          retention-days: 5

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -la artifacts/

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/*
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
